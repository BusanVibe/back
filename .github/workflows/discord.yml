name: Notify Discord on PR Merge to Main

on:
  pull_request:
    types: [closed]

jobs:
  notify-discord:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get merged commits
        id: get_commits
        run: |
          # PR 머지 커밋 리스트를 가져옵니다.
          # github.event.pull_request.commits 는 커밋 개수이므로 커밋 SHA 목록은 API 호출 필요
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          
          # GitHub API로 PR 커밋 목록을 가져와서 메시지만 뽑기
          COMMITS=$(curl -sSL -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/commits" | jq -r '.[].commit.message')
          
          # 여러 줄인 커밋 메시지를 한 줄로 바꾸기 (디스코드 메시지 용)
          echo "::set-output name=messages::$(echo "$COMMITS" | jq -Rs .)"

      - name: Send Discord Webhook
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          method: POST
          contentType: application/json
          body: |
            {
              "content": "PR #${{ github.event.pull_request.number }} merged into main.\n커밋 메시지:\n${{ steps.get_commits.outputs.messages }}"
            }