name: Notify Discord on PR Merge to main

on:
  pull_request:
    types: [closed]  # PR ì¢…ë£Œ ì´ë²¤íŠ¸

jobs:
  notify-discord:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get commits of merged PR
        id: get_commits
        run: |
          # PR ë²ˆí˜¸
          PR_NUM=${{ github.event.pull_request.number }}

          echo "Fetching commits for PR #$PR_NUM"
          # GitHub APIë¡œ PR ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          COMMITS_JSON=$(curl -sSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM/commits")

          # jqë¡œ ì»¤ë°‹ í•´ì‹œ, ì‘ì„±ì, ë©”ì‹œì§€ë¥¼ íŒŒì‹±í•´ì„œ êµ¬ë¶„ì | ë¡œ í•œ ì¤„ì”© ë§Œë“¦
          COMMITS=$(echo "$COMMITS_JSON" | jq -r '.[] | "\(.sha[0:7])|\(.commit.author.name)|\(.commit.message | split("\n")[0])"')

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build Discord message
        id: build_message
        run: |
          commits="${{ steps.get_commits.outputs.commits }}"
          message="ğŸš€ **PR #${{ github.event.pull_request.number }} ë¨¸ì§€ ì™„ë£Œ** (main ë¸Œëœì¹˜)\n\n"
          message+="ë¨¸ì§€í•œ ì‚¬ëŒ: @${{ github.actor }}  \n"
          count=$(echo "$commits" | wc -l)
          message+="ì»¤ë°‹ $count ê°œ í¬í•¨  \n"
          message+="ë¨¸ì§€ ì‹œê°„: $(date '+%Y-%m-%d %H:%M')\n\n"
          message+="ì»¤ë°‹ ë‚´ì—­:\n"

          while IFS='|' read -r hash author subject; do
            url="https://github.com/${{ github.repository }}/commit/$hash"
            emoji="âš™ï¸"
            if echo "$subject" | grep -iq "fix"; then emoji="ğŸ›"; fi
            if echo "$subject" | grep -iq "add\|feat"; then emoji="âœ¨"; fi
            if echo "$subject" | grep -iq "breaking\|migrate"; then emoji="âš ï¸"; fi

            message+="- [$hash]($url) $emoji $subject\n"
          done <<< "$commits"

          echo "message=$message" >> $GITHUB_OUTPUT

      - name: Send Discord webhook
        uses: bbhoss/webhook-dispatch@v1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          method: POST
          contentType: application/json
          body: |
            {
              "content": "${{ steps.build_message.outputs.message }}"
            }
