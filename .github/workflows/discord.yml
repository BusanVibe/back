name: Notify Discord on PR Merge to main

on:
  pull_request:
    types: [closed]

jobs:
  notify-discord:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Get commits of merged PR
        id: get_commits
        run: |
          PR_NUM=${{ github.event.pull_request.number }}

          COMMITS_JSON=$(curl -sSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM/commits")

          COMMITS=$(echo "$COMMITS_JSON" | jq -r '.[] | "\(.sha[0:7])|\(.commit.author.name)|\(.commit.message | split("\n")[0])"')

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build Discord message
        id: build_message
        run: |
          commits="${{ steps.get_commits.outputs.commits }}"
          message="ğŸš€ **PR #${{ github.event.pull_request.number }} ë¨¸ì§€ ì™„ë£Œ** (main ë¸Œëœì¹˜)\n\n"
          message+="ë¨¸ì§€í•œ ì‚¬ëŒ: @${{ github.actor }}  \n"
          count=$(echo "$commits" | wc -l)
          message+="ì»¤ë°‹ $count ê°œ í¬í•¨  \n"
          message+="ë¨¸ì§€ ì‹œê°„: $(date '+%Y-%m-%d %H:%M')\n\n"
          message+="ì»¤ë°‹ ë‚´ì—­:\n"

          while IFS='|' read -r hash author subject; do
            url="https://github.com/${{ github.repository }}/commit/$hash"
            emoji="âš™ï¸"
            if echo "$subject" | grep -iq "fix"; then emoji="ğŸ›"; fi
            if echo "$subject" | grep -iq "add\|feat"; then emoji="âœ¨"; fi
            if echo "$subject" | grep -iq "breaking\|migrate"; then emoji="âš ï¸"; fi

            message+="- [$hash]($url) $emoji $subject\n"
          done <<< "$commits"

          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo -e "$message" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord webhook
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"${{ steps.build_message.outputs.message }}\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
