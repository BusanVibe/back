name: Notify Discord on PR Merge to main

on:
  pull_request:
    types: [closed]

jobs:
  notify-discord:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      # ê°œì¸ í† í° í•„ìš” ì‹œ ì•„ë˜ ì£¼ì„ í•´ì œ í›„ secretsì— ë“±ë¡
      # GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Get PR number
        run: echo "PR_NUM=${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Fetch commits for PR
        id: fetch_commits
        run: |
          COMMITS_JSON=$(curl -sSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ env.PR_NUM }}/commits")

          echo "$COMMITS_JSON" > commits.json

          # ì»¤ë°‹ ë¦¬ìŠ¤íŠ¸ ë©”ì‹œì§€ ìƒì„± (3ê°œ ì œí•œ, ë§í¬ í¬í•¨)
          COMMITS_MSG=$(echo "$COMMITS_JSON" | jq -r '[.[] | {sha: .sha[:7], url: .html_url, message: .commit.message}] | .[:3] | map("- [\(.sha)](\(.url)) \(.message)") | join("\n")')

          echo "COMMITS_MSG<<EOF" >> $GITHUB_ENV
          echo "$COMMITS_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Discord notification
        run: |
          USERNAME="${{ github.actor }}"
          NOW=$(date '+%Y-%m-%d %H:%M')

          CONTENT="ğŸš€ **ë°°í¬ ì™„ë£Œ** (main ë¸Œëœì¹˜)\n\në°°í¬ì: @$USERNAME\nì»¤ë°‹ ${#COMMITS_MSG[@]}ê°œ í¬í•¨\në°°í¬ ì‹œê°„: $NOW\n\nì»¤ë°‹ ë‚´ì—­:\n$COMMITS_MSG"

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"$CONTENT\"}" \
            "$DISCORD_WEBHOOK_URL"
        env:
          COMMITS_MSG: ${{ env.COMMITS_MSG }}
