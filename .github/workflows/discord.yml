name: Notify Discord on PR merge to main

on:
  pull_request:
    types: [closed]

jobs:
  notify-discord:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Get PR commits messages
        id: get_commits
        run: |
          echo "Fetching commits for PR #${{ github.event.pull_request.number }}"
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits")

          echo "$response" > response.json
          cat response.json

          if echo "$response" | jq -e . >/dev/null 2>&1; then
            echo "$response" | jq -r '.[] | "- " + .commit.message' > commit_messages.txt
          else
            echo "[]" > commit_messages.txt
          fi

          commit_messages=$(paste -sd '\n' commit_messages.txt)
          echo "commit_messages<<EOF" >> $GITHUB_OUTPUT
          echo "$commit_messages" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord webhook notification
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\":\":tada: PR #${{ github.event.pull_request.number }} merged into main!\n**Title:** ${{ github.event.pull_request.title }}\n**Author:** ${{ github.event.pull_request.user.login }}\n**Commits:**\n${{ steps.get_commits.outputs.commit_messages }}\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
